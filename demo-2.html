<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title></title>
  <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/dist/css/angular-bootstrap-calendar.min.css"/>
</head>
<body ng-app="app.jamon2">
<div ng-controller="jamonCtrl as jamon" class="container">

  <div class="row">
    <div class="col-sm-12 text-center">
      <h1>Calendar View</h1>
    </div>
    <div style="height: 600px; overflow: auto" class="col-sm-6">

      <div class="col-md-12 text-center">
        <!--<div class="btn-group">-->
        <label ng-class="jamon.calendar_config.calendarView === 'month' ? 'btn btn-primary active' : 'btn btn-primary'"
               ng-click="jamon.change_current_view_to('month')">Show calendar</label>
        <label ng-class="jamon.calendar_config.calendarView === 'day' ? 'btn btn-primary active' : 'btn btn-primary'"
               ng-click="jamon.change_current_view_to('day')">Show today events</label>
        <!--</div>-->
      </div>

      <div ng-if="jamon.calendar_config.calendarView === 'day'" class="col-md-12 text-center">
        <br/>
        <div class="btn-group">
          <!--<button class="btn btn-primary" ng-click="jamon.calendar_config.control.prev()">Previous</button>-->
          <a ng-click="jamon.calendar_config.control.prev()">Previous day</a>
          -
          <!--<button class="btn btn-default" ng-click="setCalendarToToday()">Today</button>-->
          <!--<button class="btn btn-primary" ng-click="jamon.calendar_config.control.next()">Next</button>-->
          <a ng-click="jamon.calendar_config.control.next()">Next day</a>
        </div>
      </div>

      <mwl-calendar
        events="jamon.calendar_config.events"
        view="'month'"
        view-title="eltitulo"
        current-day="jamon.calendar_config.currentDay"
        on-event-click="jamon.calendar_config.eventClick(calendarEvent)"
        edit-event-html="jamon.calendar_config.editEventHtml"
        delete-event-html="jamon.calendar_config.deleteEventHtml"
        on-edit-event-click="jamon.calendar_config.editEventClick(calendarEvent)"
        on-delete-event-click="jamon.calendar_config.deleteEventClick(calendarEvent)"
        auto-open="false"
        let-change-the-view="false"
        ></mwl-calendar>
    </div>
    <div class="col-sm-6">
      <pre>{{ jamon.calendar_config.currentDay | date:'mediumDate' }}</pre>
      <mwl-calendar
        events="jamon.calendar_config.events"
        view="'day'"
        view-title="eltitulo"
        current-day="jamon.calendar_config.currentDay"
        on-event-click="jamon.calendar_config.eventClick(calendarEvent)"
        edit-event-html="jamon.calendar_config.editEventHtml"
        delete-event-html="jamon.calendar_config.deleteEventHtml"
        on-edit-event-click="jamon.calendar_config.editEventClick(calendarEvent)"
        on-delete-event-click="jamon.calendar_config.deleteEventClick(calendarEvent)"
        auto-open="true"
        let-change-the-view="false"
        ></mwl-calendar>
    </div>
  </div>
  <div class="row">
    <!--<pre style="height: 280px; overflow: auto">{{ jamon.calendar_config | json }}</pre>-->
  </div>
</div>
<script src="/docs/bower_components/Faker/build/build/faker.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
<!--https://github.com/a8m/angular-filter#get-started-->
<script src="//cdnjs.cloudflare.com/ajax/libs/angular-filter/0.5.4/angular-filter.min.js"></script>
<script src="/dist/js/angular-bootstrap-calendar-tpls.min.js"></script>
<script>
  angular.module('app.jamon2', ['mwl.calendar', 'angular.filter'])
    .config(function(calendarConfigProvider) {
      calendarConfigProvider.setMonthConfigs({
        eventFilterBy: 'warning'
      });
    })
    .factory('CalendarConfig', function ($filter, CalendarListener,
                                         $window,
                                         $log) {

      var testAction = testAction;

       var los_eventos = new Array(15).join().split(',')
                                      .map(function (item, index) {
                                          return ++index;
                                      });

        los_eventos = los_eventos.map(function (element, index) {

         var from = $window.moment();
         var to = $window.moment().add(7, 'days');
         var date = $window.faker.date.between(from, to);
         var random_title = $window.faker.internet.email();

         var start = $window.moment(date).startOf('hour').format('YYYY-MM-DD HH:mm');
         var end = $window.moment(start).add(30, 'minutes').format('YYYY-MM-DD HH:mm');
         var types = ['success', 'important', 'warning', 'jamon'];
         var type = types[Math.floor(Math.random() * types.length)];

         return {
           unique: new Date().getTime(),
           title: random_title,
           type: type,
           startsAt: start,
           endsAt: end,
           incrementsBadgeTotal: false // to not show a number in the badge with the current events during day
         };
        });
      
      var calendar = {
        events: los_eventos,
        calendarView: 'month',
        currentDay: new Date(),
        control: undefined,
        eventClick: testAction,
        editEventHtml: '<i class=\'glyphicon glyphicon-pencil\'></i>',
        deleteEventHtml: '<i class=\'glyphicon glyphicon-remove\'></i>',
        editEventClick: testAction,
        deleteEventClick: testAction,
        autoOpen: false
      };

      var service = {
        get_calendar: get_calendar
      };

      CalendarListener.event_was_clicked_handler(event_clicked_actions);
      CalendarListener.hour_was_clicked_handler(hour_clicked_actions);

      return service;

      function hour_clicked_actions(event, data) {
        add_event_to_events(data, calendar.events);
      }

      function event_clicked_actions(event, data) {
        if (data.$event.type === 'warning') {
          remove_event_from_events(data.$event.unique, calendar.events);
        }
      }

      function remove_event_from_events(event_unique_id, events_array) {
        // for ie 8 we need a polyfill for 'filter'
        // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter

        // feel this filter is not the way immutable?
        // but angular does not reacts as desire

        // events_array = events_array.filter(function (element, index, array) {
        events_array.filter(function (element, index, array) {
          if (element.unique === event_unique_id) {
            array.splice(index, 1); // mutable way ftw?
            // return false;
          }
          // return true;
        });

        // another alternative perhaps this does not need pollyfill?

        //$filter('filter')(events_array, function(element, index){
        //   $log.debug(element.unique !== event.unique);
        //  return element.unique !== event.unique
        //}, true);
      }

      function get_calendar() {
        return calendar;
      }

      /**
       *
       * @param data (day, hour, minute, title, type)
       * @param events_array
       */
      function add_event_to_events(data, events_array) {
        console.log('add_event_to_events');
        console.log(data);
        var init_event = $window
          .moment(data.day)
          .hour(data.hour)
          .minute(data.minute)
          .format('YYYY-MM-DD HH:mm');

        // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map

        boolean_array = events_array.map(function (element, index, array) {

          return $window
              .moment(element.startsAt)
              .format('YYYY-MM-DD HH:mm') === $window.moment(init_event).format('YYYY-MM-DD HH:mm');
        });

        var event_schedule_exist = boolean_array.indexOf(true) !== -1;

        if (event_schedule_exist) {
          console.log('event_schedule_exist')
          return false;
        }

        var end_event = $window
          .moment(data.day)
          .hour(data.hour)
          .minute(data.minute)
          .add(30, 'minutes')
          .format('YYYY-MM-DD HH:mm');

        var new_event = {
          title: 'not available',
          type: 'warning',
          startsAt: init_event,
          endsAt: end_event,
          unique: new Date().getTime()
        };

        events_array.push(new_event);
      }

      function testAction(data) {
        console.log('something happen!!');
      }

      function whenEventOnSelect(start, end, jsEvent, view) {
        console.log(arguments);
        ctrl.eventSources.events.push({
          "title": "my sweet event",
          "start": "2015-04-02T11:30:00",
          "backgroundColor": "green",
          "allDay": false
        })
      }

      function get_days_of_the_week() {
        var start_of_the_week = moment().startOf('week');
        var dates = [
          start_of_the_week,
          start_of_the_week.clone().add(1, 'day'),
          start_of_the_week.clone().add(2, 'day'),
          start_of_the_week.clone().add(3, 'day'),
          start_of_the_week.clone().add(4, 'day'),
          start_of_the_week.clone().add(5, 'day'),
          start_of_the_week.clone().add(6, 'day')
        ];

        var formatted_dates = [];

        angular.forEach(dates, function (value, key) {
          this.push(value.format('YYYY-MM-DD'));
        }, formatted_dates);

        return formatted_dates;

      }
    })
    .factory('CalendarListener', function ($rootScope) {
      var service = {
        hour_was_clicked_handler: when_hour_clicked,
        event_was_clicked_handler: when_event_clicked
      };

      return service;

      ////////////

      function when_event_clicked(callback) {
        $rootScope.$on('eventWasClicked', function (event, data) {
          callback(event, data)
        });
      }

      function when_hour_clicked(callback) {
        $rootScope.$on('hourWasClicked', function (event, data) {
          callback(event, data)
        });
      }
    })
    .controller('jamonCtrl', function ($scope, CalendarConfig) {
      var ctrl = this;
      ctrl.type_of_showed_events = 'important';
      ctrl.change_current_view_to = change_current_view_to;
      ctrl.calendar_config = CalendarConfig.get_calendar(0);

      console.log(ctrl.calendar_config);
      function change_current_view_to(new_view) {
        ctrl.calendar_config.calendarView = new_view;
      }
    });
</script>
</body>
</html>
